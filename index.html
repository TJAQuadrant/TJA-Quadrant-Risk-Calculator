<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TJA Risk Stratification Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            color: #333;
        }
        
        .header {
            text-align: center;
            background: #f8f9fa;
            padding: 30px;
            border: 1px solid #dee2e6;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: normal;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1em;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .section {
            background: white;
            padding: 25px;
            border: 1px solid #dee2e6;
        }
        
        .section h2 {
            color: #333;
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: normal;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: normal;
            color: #333;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #666;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
            margin: 20px 0;
        }
        
        .calculate-btn:hover {
            background: #0056b3;
        }
        
        .results {
            background: white;
            padding: 25px;
            border: 1px solid #dee2e6;
        }
        
        .quadrant {
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            border: 1px solid #333;
        }
        
        .score-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .score-card {
            padding: 15px;
            background: #f8f9fa;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .score-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .clinical-guidance {
            background: #f8f9fa;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .score-display {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>TJA Risk Stratification Calculator</h1>
        <p>Surgical Stress and Physiological Reserve Framework</p>
    </div>

    <div class="container">
        <div class="section">
            <h2>Hemodynamic Stress Index (HSI)</h2>
            
            <div class="form-group">
                <label for="optime">Operative Time (minutes):</label>
                <input type="number" id="optime" min="0" max="600" step="1">
            </div>
            
            <div class="form-group">
                <label for="workrvu">Work RVU:</label>
                <input type="number" id="workrvu" min="0" max="50" step="0.01">
            </div>
            
            <div class="form-group">
                <label for="transfus">Preoperative Transfusion:</label>
                <select id="transfus">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="bleeddis">Bleeding Disorder:</label>
                <select id="bleeddis">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="bmi">BMI (kg/mÂ²):</label>
                <input type="number" id="bmi" min="10" max="80" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="casetype">Case Type:</label>
                <select id="casetype">
                    <option value="">Select...</option>
                    <option value="0">Elective</option>
                    <option value="1">Urgent</option>
                    <option value="2">Emergent</option>
                </select>
            </div>
        </div>

        <div class="section">
            <h2>Physiologic Reserve Score (PRS)</h2>
            
            <div class="form-group">
                <label for="pralbum">Preoperative Albumin (g/dL):</label>
                <input type="number" id="pralbum" min="1" max="6" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="prcreat">Preoperative Creatinine (mg/dL):</label>
                <input type="number" id="prcreat" min="0.1" max="10" step="0.01">
            </div>
            
            <div class="form-group">
                <label for="fnstatus2">Functional Status:</label>
                <select id="fnstatus2">
                    <option value="">Select...</option>
                    <option value="0">Independent</option>
                    <option value="1">Partially Dependent</option>
                    <option value="2">Totally Dependent</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="age">Age (years):</label>
                <input type="number" id="age" min="18" max="120" step="1">
            </div>
            
            <div class="form-group">
                <label for="diabetes">Diabetes:</label>
                <select id="diabetes">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Non-Insulin</option>
                    <option value="2">Insulin</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="hxcopd">COPD:</label>
                <select id="hxcopd">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="hxchf">Congestive Heart Failure:</label>
                <select id="hxchf">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="ventilat">Ventilator Dependent:</label>
                <select id="ventilat">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="dialysis">Dialysis:</label>
                <select id="dialysis">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="steroid">Chronic Steroid Use:</label>
                <select id="steroid">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="hypermed">Hypertension Requiring Medication:</label>
                <select id="hypermed">
                    <option value="">Select...</option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
        </div>
    </div>

    <button class="calculate-btn" onclick="calculateRisk()">Calculate Risk Stratification</button>

    <div class="results" id="results" style="display: none;">
        <h2>Results</h2>
        <div class="score-display">
            <div class="score-card">
                <div>HSI Score</div>
                <div class="score-value" id="hsi-score">--</div>
            </div>
            <div class="score-card">
                <div>PRS Score</div>
                <div class="score-value" id="prs-score">--</div>
            </div>
        </div>
        
        <div id="quadrant-result" class="quadrant">
            Risk Quadrant will appear here
        </div>
        
        <div class="clinical-guidance" id="clinical-guidance">
            Clinical guidance will appear here
        </div>
    </div>

    <script>
        // Data from your analysis
        const calculatorData = {
            "hsi_coefficients": {
                "OPTIME": 0.583272,
                "WORKRVU": 0.615246,
                "TRANSFUS": 0.309283,
                "BLEEDDIS": 0.208638,
                "BMI": -0.072901,
                "CASETYPE": 0.369818
            },
            "prs_coefficients": {
                "PRALBUM": 0.230953,
                "PRCREAT": 0.397236,
                "FNSTATUS2": 0.171951,
                "Age": 0.269358,
                "DIABETES": 0.244815,
                "HXCOPD": 0.185657,
                "HXCHF": 0.628103,
                "VENTILAT": 0.040879,
                "DIALYSIS": 0.301918,
                "STEROID": 0.067811,
                "HYPERMED": 0.316866
            },
            "hsi_stats": {
                "OPTIME": {"mean": 98.018941, "std": 42.467414},
                "WORKRVU": {"mean": 20.048751, "std": 2.008134},
                "TRANSFUS": {"mean": 0.002209, "std": 0.046951},
                "BLEEDDIS": {"mean": 0.024765, "std": 0.155407},
                "BMI": {"mean": 31.703440, "std": 6.871588},
                "CASETYPE": {"mean": 0.026489, "std": 0.193069}
            },
            "prs_stats": {
                "PRALBUM": {"mean": 4.193268, "std": 0.408048},
                "PRCREAT": {"mean": 0.925020, "std": 0.444656},
                "FNSTATUS2": {"mean": 0.019180, "std": 0.143828},
                "Age": {"mean": 66.962406, "std": 10.202236},
                "DIABETES": {"mean": 0.216227, "std": 0.498749},
                "HXCOPD": {"mean": 0.038483, "std": 0.192360},
                "HXCHF": {"mean": 0.034400, "std": 0.182255},
                "VENTILAT": {"mean": 0.000133, "std": 0.011536},
                "DIALYSIS": {"mean": 0.002316, "std": 0.048066},
                "STEROID": {"mean": 0.052899, "std": 0.223832},
                "HYPERMED": {"mean": 0.627360, "std": 0.483509}
            },
            "hsi_cutoff": -0.317565,
            "prs_cutoff": 0.202681
        };

        function calculateZScore(value, mean, std, isInverted = false) {
            if (isInverted) {
                return (mean - value) / std;
            }
            return (value - mean) / std;
        }

        function calculateRisk() {
            // Validate inputs
            const hsiInputs = ['optime', 'workrvu', 'transfus', 'bleeddis', 'bmi', 'casetype'];
            const prsInputs = ['pralbum', 'prcreat', 'fnstatus2', 'age', 'diabetes', 'hxcopd', 'hxchf', 'ventilat', 'dialysis', 'steroid', 'hypermed'];
            
            let valid = true;
            [...hsiInputs, ...prsInputs].forEach(input => {
                const element = document.getElementById(input);
                if (!element.value && element.value !== '0') {
                    element.style.borderColor = '#e53e3e';
                    valid = false;
                } else {
                    element.style.borderColor = '#e2e8f0';
                }
            });
            
            if (!valid) {
                alert('Please fill in all fields');
                return;
            }

            // Variable name mapping
            const variableMap = {
                'optime': 'OPTIME',
                'workrvu': 'WORKRVU', 
                'transfus': 'TRANSFUS',
                'bleeddis': 'BLEEDDIS',
                'bmi': 'BMI',
                'casetype': 'CASETYPE',
                'pralbum': 'PRALBUM',
                'prcreat': 'PRCREAT',
                'fnstatus2': 'FNSTATUS2',
                'age': 'Age',  // Note: Age is capitalized differently
                'diabetes': 'DIABETES',
                'hxcopd': 'HXCOPD',
                'hxchf': 'HXCHF',
                'ventilat': 'VENTILAT',
                'dialysis': 'DIALYSIS',
                'steroid': 'STEROID',
                'hypermed': 'HYPERMED'
            };

            // Calculate HSI
            let hsiScore = 0;
            hsiInputs.forEach(input => {
                const value = parseFloat(document.getElementById(input).value);
                const varName = variableMap[input];
                const zScore = calculateZScore(
                    value, 
                    calculatorData.hsi_stats[varName].mean, 
                    calculatorData.hsi_stats[varName].std
                );
                hsiScore += zScore * calculatorData.hsi_coefficients[varName];
            });

            // Calculate PRS (note PRALBUM is inverted)
            let prsScore = 0;
            prsInputs.forEach(input => {
                const value = parseFloat(document.getElementById(input).value);
                const varName = variableMap[input];
                const isInverted = varName === 'PRALBUM';
                const zScore = calculateZScore(
                    value, 
                    calculatorData.prs_stats[varName].mean, 
                    calculatorData.prs_stats[varName].std,
                    isInverted
                );
                prsScore += zScore * calculatorData.prs_coefficients[varName];
            });

            // Apply direction correction (based on your analysis)
            prsScore = -prsScore;

            // Determine quadrant
            const highStress = hsiScore > calculatorData.hsi_cutoff;
            const highReserve = prsScore > calculatorData.prs_cutoff;
            
            let quadrant, guidance;
            
            if (highStress && !highReserve) {
                quadrant = "High Stress / Low Reserve (HS/LR)";
                guidance = "<strong>Highest Risk</strong><br>Consider: Prehabilitation, comorbidity optimization, extended monitoring, avoid same-day discharge. These patients benefit from structured preoperative interventions and enhanced postoperative surveillance.";
            } else if (highStress && highReserve) {
                quadrant = "High Stress / High Reserve (HS/HR)";
                guidance = "<strong>Moderate-High Risk</strong><br>Physiologic resilience helps buffer surgical stress. Standard perioperative protocols appropriate with routine monitoring.";
            } else if (!highStress && !highReserve) {
                quadrant = "Low Stress / Low Reserve (LS/LR)";
                guidance = "<strong>Moderate Risk</strong><br>Despite lower surgical stress, limited physiologic reserve requires closer surveillance and potentially delayed discharge planning.";
            } else {
                quadrant = "Low Stress / High Reserve (LS/HR)";
                guidance = "<strong>Lowest Risk</strong><br>Ideal candidates for outpatient TJA, same-day discharge, and accelerated recovery pathways.";
            }

            // Display results
            document.getElementById('hsi-score').textContent = hsiScore.toFixed(3);
            document.getElementById('prs-score').textContent = prsScore.toFixed(3);
            
            const quadrantElement = document.getElementById('quadrant-result');
            quadrantElement.textContent = quadrant;
            quadrantElement.className = 'quadrant';
            
            document.getElementById('clinical-guidance').innerHTML = guidance;
            document.getElementById('results').style.display = 'block';
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>